# Функциональность работы с Excel для сотрудников

## Описание

Добавлена возможность скачивания актуального шаблона Excel с данными сотрудников и загрузки обновленного файла для массового обновления базы данных с поддержкой полной синхронизации.

## Новые возможности

### 1. Скачивание шаблона Excel
- **URL**: `/employees/excel-template/`
- **Права доступа**: `stimuli.view_employee`
- **Функция**: Генерирует Excel файл с актуальными данными всех сотрудников
- **Содержимое файла**:
  - Лист "Сотрудники" - полные данные сотрудников со всеми столбцами
  - Лист "Подразделения" - справочник подразделений
  - Лист "Должности" - справочник должностей с окладами
  - Лист "Категории" - справочник категорий сотрудников

### 2. Загрузка Excel файла с режимами синхронизации
- **URL**: `/employees/excel-upload/`
- **Права доступа**: `stimuli.add_employee`
- **Функция**: Обрабатывает загруженный Excel файл и синхронизирует базу данных
- **Поддерживаемые форматы**: `.xlsx`, `.xls`
- **Максимальный размер**: 10 МБ
- **Режимы синхронизации**:
  - **Только добавить/обновить**: Создает новых и обновляет существующих сотрудников
  - **Полная синхронизация**: Дополнительно удаляет сотрудников, отсутствующих в файле

## Структура Excel файла

### Лист "Сотрудники" (16 столбцов)
| Колонка | Описание | Обязательно | Формат | Редактируемо |
|---------|----------|-------------|---------|--------------|
| ФИО | Полное имя сотрудника | Да | Текст | ✅ |
| Подразделение | Название подразделения | Да | Из справочника | ✅ |
| Должность | Название должности | Да | Из справочника | ✅ |
| Категория | Категория сотрудника | Да | АУП/ППС/Другое (или полные названия) | ✅ |
| Ставка | Размер ставки | Нет | Число (по умолчанию 1.0) | ✅ |
| Оклад | Базовый оклад должности | Нет | Число | ❌ (вычисляемое) |
| Выплаты по ставке | Оклад × ставка | Нет | Число | ❌ (вычисляемое) |
| Совмещения | Описание совмещений | Нет | Текст | ❌ (вычисляемое) |
| Оклад совмещений | Сумма окладов совмещений | Нет | Число | ❌ (вычисляемое) |
| Итого базовых выплат | Общая сумма базовых выплат | Нет | Число | ❌ (вычисляемое) |
| Надбавка | Размер надбавки | Нет | Число (по умолчанию 0.0) | ✅ |
| Основание надбавки | Причина надбавки | Нет | Текст | ✅ |
| Срок надбавки | Дата окончания надбавки | Нет | ДД.ММ.ГГГГ | ✅ |
| Выплата | Размер выплаты | Нет | Число (по умолчанию 0.0) | ✅ |
| Обоснование | Обоснование выплаты | Нет | Текст | ✅ |
| Итого выплат | Общая сумма всех выплат | Нет | Число | ❌ (вычисляемое) |

## Логика обработки

### При загрузке файла:
1. **Валидация файла**: Проверка расширения и размера
2. **Чтение данных**: Парсинг Excel файла построчно
3. **Валидация данных**: Проверка корректности значений
4. **Обработка записей**:
   - Если сотрудник с таким ФИО существует → обновление данных
   - Если сотрудник не существует → создание новой записи
5. **Синхронизация** (при выборе полной синхронизации):
   - Удаление сотрудников, отсутствующих в файле
6. **Отчет о результатах**: Количество созданных/обновленных/удаленных записей и ошибки

### Режимы синхронизации:

#### Только добавить/обновить
- ✅ Создает новых сотрудников
- ✅ Обновляет существующих сотрудников
- ❌ Не удаляет записи
- **Рекомендуется для**: Добавления новых сотрудников и обновления данных

#### Полная синхронизация
- ✅ Создает новых сотрудников
- ✅ Обновляет существующих сотрудников
- ⚠️ **Удаляет сотрудников, отсутствующих в файле**
- **Рекомендуется для**: Полной синхронизации с внешней системой
- **⚠️ Внимание**: Может привести к потере данных!

### Обработка ошибок:
- Некорректные подразделения/должности
- Неверные категории
- Некорректные числовые значения
- Неверный формат дат
- Дублирование ФИО

## Интерфейс

### В списке сотрудников добавлены кнопки:
- **"Скачать Excel"** - для скачивания шаблона
- **"Загрузить Excel"** - для перехода к форме загрузки

### Страница загрузки включает:
- Инструкции по использованию
- Форму загрузки файла с валидацией
- Выбор режима синхронизации
- Кнопку скачивания шаблона
- Описание режимов синхронизации
- Важные замечания по формату данных

## Технические детали

### Используемые библиотеки:
- `openpyxl` - для работы с Excel файлами
- Django Forms - для валидации загружаемых файлов

### Новые представления:
- `EmployeeExcelTemplateView` - генерация шаблона
- `EmployeeExcelUploadView` - обработка загрузки

### Новые формы:
- `EmployeeExcelUploadForm` - валидация загружаемых файлов с выбором режима синхронизации

### Новые URL маршруты:
- `employee-excel-template/` - скачивание шаблона
- `employee-excel-upload/` - загрузка файла

## Безопасность

- Проверка прав доступа для всех операций
- Валидация размера и типа файлов
- Обработка ошибок без раскрытия внутренней структуры
- Защита от загрузки некорректных файлов
- Предупреждения о потенциальной потере данных при полной синхронизации

## Рекомендации по использованию

1. **Регулярное обновление**: Используйте режим "Только добавить/обновить" для регулярных обновлений
2. **Полная синхронизация**: Используйте только при необходимости полного соответствия с внешней системой
3. **Резервное копирование**: Перед полной синхронизацией создайте резервную копию данных
4. **Тестирование**: Сначала протестируйте на небольшом наборе данных
