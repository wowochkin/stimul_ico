# Устранение проблем с системой прав доступа

## Проблема: Сотрудники могут добавлять заявки в архивные кампании и редактировать статус заявок

### Причина
Сотрудники имели доступ ко всем кампаниям и могли изменять статус заявок, что не должно быть доступно.

### Решение
Проблема исправлена в коде. Теперь:

#### Доступ к кампаниям:
- **Сотрудники** видят только открытые кампании (статус OPEN)
- **Руководители департамента** видят все кампании кроме черновиков
- **Администраторы** видят все кампании кроме черновиков

#### Права на изменение статуса заявок:
- **Сотрудники** НЕ могут изменять статус заявок (даже своих)
- **Руководители департамента** могут изменять статус заявок только своего подразделения
- **Администраторы** могут изменять статус всех заявок

### Проверка
```bash
python3 manage.py test_employee_restrictions
```

## Проблема: Руководители департамента видят все подразделения в форме массового создания заявок

### Причина
Форма массового создания заявок не фильтровала подразделения по правам доступа пользователя.

### Решение
Проблема исправлена в коде. Теперь:
- **Руководители департамента** видят только свое подразделение
- **Сотрудники** не видят подразделения (так как не должны использовать массовое создание)
- **Администраторы** видят все подразделения

### Проверка
```bash
python3 manage.py test_division_filtering
```

## Проблема: В админке не видно связей между пользователями и сотрудниками

### Причина
В базе данных могли остаться старые записи сотрудников без связи с пользователями, что создает путаницу в админке.

### Решение

1. **Очистить и пересоздать все связи:**
```bash
python3 manage.py reset_user_connections --clean
```

2. **Или только очистить дублирующиеся записи:**
```bash
python3 manage.py clean_employees
```

3. **Проверить результат:**
```bash
python3 manage.py shell -c "
from django.contrib.auth.models import User
from stimuli.models import Employee
for user in User.objects.filter(username__in=['manager_dev', 'employee_dev', 'manager_marketing', 'employee_marketing']):
    try:
        emp = user.employee_profile
        print(f'✓ {user.username} -> {emp.full_name} ({emp.division.name})')
    except:
        print(f'✗ {user.username} -> НЕТ СВЯЗИ')
"
```

### Ожидаемый результат

После выполнения команд вы должны увидеть:
- ✓ manager_dev -> Иван Петров (Отдел разработки)
- ✓ employee_dev -> Анна Сидорова (Отдел разработки)
- ✓ manager_marketing -> Мария Козлова (Отдел маркетинга)
- ✓ employee_marketing -> Дмитрий Иванов (Отдел маркетинга)

### Проверка в админке

1. Зайдите в админку Django
2. Перейдите в раздел "Сотрудники"
3. Убедитесь, что у каждого сотрудника указан пользователь в поле "Пользователь"
4. Перейдите в раздел "Подразделения пользователей"
5. Убедитесь, что у руководителей департамента указаны их подразделения

### Тестирование прав доступа

1. Войдите как `manager_dev` (password123)
2. Попробуйте создать заявку - должны видеть сотрудников отдела разработки
3. Войдите как `employee_dev` (password123)
4. Попробуйте создать заявку - должны видеть только себя

Если проблемы остаются, выполните команды очистки еще раз.
