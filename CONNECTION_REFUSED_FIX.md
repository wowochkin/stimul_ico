# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "connection refused" –æ—à–∏–±–∫–∏

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

Railway –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É:
```json
"error":"connection refused"
"upstreamErrors": [
  {"error":"connection refused","duration":95},
  {"error":"connection refused","duration":92},
  {"error":"connection refused","duration":92}
]
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Railway **–ù–ï –ú–û–ñ–ï–¢ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø** –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –≤–æ–æ–±—â–µ!

–ü—Ä–∏ —ç—Ç–æ–º:
- ‚úÖ Gunicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è: `Listening at: http://0.0.0.0:8080`
- ‚úÖ Healthcheck —Ä–∞–±–æ—Ç–∞–µ—Ç: `GET /health/ HTTP/1.1" 200 90`
- ‚ùå –í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç "connection refused"

## üõ† –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –£–ø—Ä–æ—â–µ–Ω WSGI (`backend/stimul_ico/wsgi.py`)
**–ë—ã–ª–æ**: –°–ª–æ–∂–Ω—ã–π wrapper —Å try-except –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –ª–æ–º–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
**–°—Ç–∞–ª–æ**: –ü—Ä–æ—Å—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π WSGI –±–µ–∑ –æ–±–µ—Ä—Ç–æ–∫

### 2. –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers
**–ë—ã–ª–æ**: 3 worker'–∞
**–°—Ç–∞–ª–æ**: 1 worker –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–≠—Ç–æ –∏—Å–∫–ª—é—á–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å:
- Fork –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ú–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–µ–π –∑–∞ —Ä–µ—Å—É—Ä—Å—ã

### 3. –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ worker'–æ–≤
–î–æ–±–∞–≤–ª–µ–Ω—ã callbacks –≤ `gunicorn.conf.py`:
- `post_worker_init` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É Django –≤ –∫–∞–∂–¥–æ–º worker
- `worker_exit` - –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ worker'–æ–≤
- –í—ã–≤–æ–¥ PID –∏ –≤–µ—Ä—Å–∏–∏ Django

### 4. –†–∞—Å—à–∏—Ä–µ–Ω—ã ALLOWED_HOSTS
–î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã Railway –¥–æ–º–µ–Ω–æ–≤:
```python
ALLOWED_HOSTS = [
    RAILWAY_PUBLIC_DOMAIN,
    '.railway.app',      # –í—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã
    '.up.railway.app',   # –ù–æ–≤—ã–µ –¥–æ–º–µ–Ω—ã
    'healthcheck.railway.app',
    # ...
]
```

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã CSRF_TRUSTED_ORIGINS
```python
CSRF_TRUSTED_ORIGINS = [
    f'https://{RAILWAY_PUBLIC_DOMAIN}',
    'https://*.railway.app',
    'https://*.up.railway.app',
]
```

### 6. CORS —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è Railway
```python
if RAILWAY_PUBLIC_DOMAIN:
    CORS_ALLOW_ALL_ORIGINS = True
```

## üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –õ–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ worker'–∞

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
```
‚úÖ Worker 10 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
‚úÖ Worker 10: Django 4.x –∑–∞–≥—Ä—É–∂–µ–Ω
‚úÖ Worker 10: DEBUG=False
‚úÖ WSGI application loaded successfully
‚úÖ PID: 10
```

–ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - worker –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Django!

### 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ endpoints

```bash
# –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π
curl https://stimulico-production.up.railway.app/ultra-simple/

# Healthcheck
curl https://stimulico-production.up.railway.app/health/

# –ì–ª–∞–≤–Ω–∞—è
curl https://stimulico-production.up.railway.app/
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å:
- `‚ùå Worker X: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Django:`
- `‚ùå Worker X –∞–≤–∞—Ä–∏–π–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω`
- `üëã Worker X –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É` (–±–µ–∑ —è–≤–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã)

## üéØ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã "connection refused"

### 1. Worker –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Django
**–°–∏–º–ø—Ç–æ–º**: –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π "Worker –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
**–†–µ—à–µ–Ω–∏–µ**: –°–º–æ—Ç—Ä–µ—Ç—å traceback –≤ –ª–æ–≥–∞—Ö

### 2. Worker –ø–∞–¥–∞–µ—Ç –Ω–∞ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
**–°–∏–º–ø—Ç–æ–º**: Worker –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –∑–∞–ø—Ä–æ—Å –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Django request handler

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é
**–°–∏–º–ø—Ç–æ–º**: Worker —É–±–∏–≤–∞–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π (OOM killer)
**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –≤ Railway

### 4. Database connection timeout
**–°–∏–º–ø—Ç–æ–º**: Worker –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –ë–î
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DATABASE_URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL

### 5. Port binding issue
**–°–∏–º–ø—Ç–æ–º**: Gunicorn –Ω–µ –º–æ–∂–µ—Ç –∑–∞–±–∏–Ω–¥–∏—Ç—å—Å—è –Ω–∞ 0.0.0.0:8080
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PORT –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –ø—Ä–∞–≤–∞

## üîß –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å preload_app = True
–í `gunicorn.conf.py`:
```python
preload_app = True  # –ó–∞–≥—Ä—É–∑–∏—Ç—å Django –î–û —Ñ–æ—Ä–∫–∞ worker'–æ–≤
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å gevent worker
```python
worker_class = 'gevent'  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π worker
```

–¢—Ä–µ–±—É–µ—Ç: `pip install gevent`

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å middleware
–í `settings.py` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É:
- WhiteNoiseMiddleware
- CorsMiddleware  
- CsrfViewMiddleware

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å —Ç–∞–∫–æ–π –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
```bash
export PORT=8080
export DATABASE_URL="postgresql://..."
export RAILWAY_PUBLIC_DOMAIN="localhost"
gunicorn --config gunicorn.conf.py stimul_ico.wsgi:application
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–µ–ø–ª–æ—è:
1. Worker –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
2. Django –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
3. –ó–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
4. –ò–ª–∏ –º—ã —É–≤–∏–¥–∏–º –¢–û–ß–ù–£–Æ –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö

–í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, —Å —Ç–∞–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –ø—Ä–∏—á–∏–Ω–∞ —Å—Ç–∞–Ω–µ—Ç —è—Å–Ω–∞!

