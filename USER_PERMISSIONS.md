# Система прав доступа для заявок на стимулирование

## Обзор

В системе реализована двухуровневая система прав доступа для работы с заявками на стимулирование:

1. **Руководитель департамента** - может формировать заявки на подразделения и отслеживать их статус
2. **Сотрудник** - может формировать заявки только на себя

## Группы пользователей

### Руководитель департамента
- **Права доступа:**
  - Создание заявок на стимулирование для сотрудников своего подразделения
  - Просмотр всех заявок своего подразделения
  - Редактирование заявок своего подразделения
  - Удаление заявок своего подразделения
  - Просмотр списка сотрудников своего подразделения
  - Массовое создание заявок для сотрудников своего подразделения

- **Ограничения:**
  - Доступ только к заявкам сотрудников своего подразделения
  - Не может работать с заявками других подразделений

### Сотрудник
- **Права доступа:**
  - Создание заявок на стимулирование только для себя
  - Просмотр только своих заявок
  - Редактирование только своих заявок в статусе "На рассмотрении"
  - Удаление только своих заявок в статусе "На рассмотрении"

- **Ограничения:**
  - Не может видеть заявки других сотрудников
  - Не может редактировать заявки после их одобрения/отклонения

## Настройка пользователей

### Создание групп пользователей
```bash
python manage.py create_user_groups
```

### Создание тестовых пользователей
```bash
python manage.py create_test_users
```

### Назначение пользователя руководителем департамента

1. Добавить пользователя в группу "Руководитель департамента"
2. Создать запись в модели `UserDivision`, связав пользователя с подразделением

Пример в админке Django:
- Перейти в раздел "Подразделения пользователей"
- Создать новую запись, указав пользователя и его подразделение

### Назначение пользователя сотрудником

1. Добавить пользователя в группу "Сотрудник"
2. Создать соответствующую запись в модели `Employee` и связать её с пользователем через поле `user`

## Техническая реализация

### Модели

#### UserDivision
Связывает пользователя с подразделением для определения прав доступа руководителей департамента.

```python
class UserDivision(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    division = models.ForeignKey('staffing.Division', on_delete=models.CASCADE)
```

#### Employee (обновлена)
Добавлена прямая связь с пользователем для упрощения управления правами доступа.

```python
class Employee(models.Model):
    user = models.OneToOneField(User, on_delete=models.SET_NULL, blank=True, null=True)
    full_name = models.CharField('ФИО', max_length=255)
    division = models.ForeignKey('staffing.Division', on_delete=models.PROTECT)
    # ... остальные поля
```

### Функции проверки прав

#### is_department_manager(user)
Проверяет, является ли пользователь руководителем департамента.

#### is_employee(user)
Проверяет, является ли пользователь сотрудником.

#### get_user_division(user)
Возвращает подразделение пользователя, если он руководитель департамента.

#### can_view_all_requests(user)
Проверяет, может ли пользователь видеть все заявки (администраторы).

#### can_edit_request(user, request)
Проверяет, может ли пользователь редактировать конкретную заявку.

#### can_delete_request(user, request)
Проверяет, может ли пользователь удалить конкретную заявку.

#### get_accessible_employees(user)
Возвращает queryset сотрудников, к которым у пользователя есть доступ.

### Права доступа в представлениях

#### StimulusRequestListView
- Фильтрует заявки в зависимости от роли пользователя
- Добавляет аннотации для определения прав редактирования/удаления

#### StimulusRequestCreateView/UpdateView
- Ограничивает выбор сотрудников в форме
- Проверяет права доступа к редактируемой заявке

#### StimulusRequestBulkCreateView
- Ограничивает доступ к подразделениям для руководителей департамента
- Фильтрует список сотрудников по правам доступа

## Тестовые пользователи

После выполнения команды `create_test_users` создаются следующие тестовые пользователи:

- **manager_dev** / password123 - Руководитель отдела разработки
- **manager_marketing** / password123 - Руководитель отдела маркетинга  
- **employee_dev** / password123 - Сотрудник

## Безопасность

- Все проверки прав доступа выполняются на уровне представлений
- Формы ограничивают выбор доступных объектов
- Queryset'ы фильтруются по правам доступа
- Дополнительные проверки в методах редактирования и удаления

## Расширение системы

Для добавления новых ролей:

1. Создать новую группу пользователей
2. Добавить функцию проверки роли в `permissions.py`
3. Обновить логику в представлениях
4. Добавить соответствующие права доступа в группы
