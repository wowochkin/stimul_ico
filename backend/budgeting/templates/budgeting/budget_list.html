{% extends 'base.html' %}

{% block title %}Бюджет | {{ block.super }}{% endblock %}

{% block content %}
<div class="card content-card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
        <h2>Бюджеты</h2>
        {% if perms.budgeting.add_budget %}
            <a href="{% url 'budgeting:budget-add' %}" class="btn btn-primary">Новый бюджет</a>
        {% endif %}
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Период</th>
                    <th>Тип</th>
                    <th>Всего</th>
                    <th>Резерв</th>
                    <th>Израсходовано</th>
                    <th>Доступно</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for budget in budgets %}
                    <tr>
                        <td>{% if budget.month %}{{ budget.month|default_if_none:'—' }}/{{ budget.year }}{% else %}{{ budget.year }}{% endif %}</td>
                        <td>{{ budget.get_budget_type_display }}</td>
                        <td>{{ budget.total_amount }}</td>
                        <td>{{ budget.reserved_amount }}</td>
                        <td>{{ budget.spent_amount }}</td>
                        <td>{{ budget.available_amount }}</td>
                        <td style="display:flex; gap:8px; flex-wrap:wrap;">
                            {% if perms.budgeting.change_budget %}
                                <a href="{% url 'budgeting:budget-edit' budget.pk %}" class="btn btn-text">Редактировать</a>
                            {% endif %}
                            {% if perms.budgeting.add_budgetallocation %}
                                <a href="{% url 'budgeting:allocation-add' budget.pk %}" class="btn btn-text">Добавить выделение</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% if budget.allocations.all %}
                        <tr>
                            <td colspan="7">
                                <div style="padding:12px 16px; background:#fafafa; border-radius:8px;">
                                    <h4 style="margin-bottom:8px;">Выделения</h4>
                                    <div class="table-wrapper">
                                        <table class="table table-nested">
                                            <thead>
                                                <tr>
                                                    <th>Цель</th>
                                                    <th>Выделено</th>
                                                    <th>Резерв</th>
                                                    <th>Израсходовано</th>
                                                    <th>Доступно</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for allocation in budget.allocations.all %}
                                                    <tr>
                                                        <td>
                                                            {% if allocation.recurring_period %}
                                                                <a href="{% url 'recurring_payments:period-detail' allocation.recurring_period_id %}">{{ allocation.recurring_period }}</a>
                                                            {% elif allocation.campaign %}
                                                                <a href="{% url 'one_time_payments:campaign-detail' allocation.campaign_id %}">{{ allocation.campaign.name }}</a>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ allocation.allocated_amount }}</td>
                                                        <td>{{ allocation.reserved_amount }}</td>
                                                        <td>{{ allocation.spent_amount }}</td>
                                                        <td>{{ allocation.available_amount }}</td>
                                                        <td style="display:flex; gap:8px; flex-wrap:wrap;">
                                                            {% if perms.budgeting.change_budgetallocation %}
                                                                <a href="{% url 'budgeting:allocation-edit' allocation.pk %}" class="btn btn-text">Изменить</a>
                                                            {% endif %}
                                                            {% if perms.budgeting.delete_budgetallocation %}
                                                                <a href="{% url 'budgeting:allocation-delete' allocation.pk %}" class="btn btn-text" style="color:#b4231a;">Удалить</a>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% empty %}
                                                    <tr>
                                                        <td colspan="6">Выделений нет.</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                {% empty %}
                    <tr>
                        <td colspan="7">Бюджеты не созданы.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">Назад</a>
            {% endif %}
            <span class="current">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Вперёд</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
