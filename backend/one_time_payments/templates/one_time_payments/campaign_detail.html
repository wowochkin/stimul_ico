{% extends 'base.html' %}

{% block title %}{{ campaign.name }} | Кампания | {{ block.super }}{% endblock %}

{% block content %}
<div class="card content-card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px; margin-bottom:16px;">
        <div>
            <h2>{{ campaign.name }}</h2>
            <p class="muted">Открытие: {{ campaign.opens_at|date:'d.m.Y' }}{% if campaign.deadline %}, дедлайн: {{ campaign.deadline|date:'d.m.Y' }}{% endif %}</p>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
            <span class="status status-{{ campaign.status }}">{{ campaign.get_status_display }}</span>
            {% if perms.one_time_payments.change_requestcampaign %}
                <a href="{% url 'one_time_payments:campaign-edit' campaign.pk %}" class="btn btn-text">Редактировать</a>
            {% endif %}
        </div>
    </div>
    {% if campaign.description %}
        <p style="margin-bottom:24px; white-space:pre-wrap;">{{ campaign.description }}</p>
    {% endif %}
    {% if perms.one_time_payments.change_requestcampaign %}
        {% if available_actions %}
            <section style="margin-bottom:24px;">
                <h3>Управление статусом</h3>
                <form method="post" action="{% url 'one_time_payments:campaign-status' campaign.pk %}" class="form-inline">
                    {% csrf_token %}
                    <label for="action">Действие</label>
                    <select name="action" id="action">
                        {% for value, label in available_actions %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Применить</button>
                </form>
            </section>
        {% endif %}
    {% endif %}
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
            <h3>Заявки кампании</h3>
            <a href="{% url 'request-list' %}?campaign={{ campaign.pk }}" class="btn btn-text">Смотреть все заявки</a>
        </div>
        <div class="table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Создано</th>
                        <th>Сотрудник</th>
                        <th>Сумма</th>
                        <th>Статус</th>
                        <th>Ответственный</th>
                        <th>Комментарий</th>
                        {% if perms.stimuli.change_stimulusrequest %}
                            <th>Управление</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for request in campaign.stimulus_requests.all %}
                        <tr>
                            <td>{{ request.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ request.employee.full_name }}</td>
                            <td>{{ request.amount }}</td>
                            <td><span class="status status-{{ request.status }}">{{ request.get_display_status }}</span></td>
                            <td>{{ request.requested_by.get_full_name|default:request.requested_by.username }}</td>
                            <td>{{ request.admin_comment|default:'—' }}</td>
                            {% if perms.stimuli.change_stimulusrequest and request.status != 'archived' %}
                                <td>
                                    <form method="post" action="{% url 'one_time_payments:campaign-request-status' campaign.pk request.pk %}" data-autosubmit="true" data-autosubmit-delay="200" style="display:flex; flex-direction:column; gap:8px;">
                                        {% csrf_token %}
                                        <select name="status">
                                            {% for value, label in request.Status.choices %}
                                                <option value="{{ value }}" {% if value == request.status %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        <textarea name="admin_comment" rows="2" placeholder="Комментарий администратора" data-autosubmit-delay="1200">{{ request.admin_comment }}</textarea>
                                    </form>
                                </td>
                            {% endif %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7">Заявок в кампании нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
            <h3>Одобренные заявки (Разовые выплаты)</h3>
            <a href="{% url 'one_time_payments:campaign-approved-export' campaign.pk %}" class="btn btn-text">Выгрузить в Excel</a>
        </div>
        <div class="table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Создано</th>
                        <th>Сотрудник</th>
                        <th>Сумма</th>
                        <th>Обоснование</th>
                        <th>Ответственный</th>
                        <th>Комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in approved_requests %}
                        <tr>
                            <td>{{ request.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ request.employee.full_name }}</td>
                            <td>{{ request.amount }}</td>
                            <td>{{ request.justification }}</td>
                            <td>{{ request.requested_by.get_full_name|default:request.requested_by.username }}</td>
                            <td>{{ request.admin_comment|default:'—' }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6">Одобренных заявок нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}
