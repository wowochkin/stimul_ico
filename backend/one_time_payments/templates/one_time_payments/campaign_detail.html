{% extends 'base.html' %}

{% block title %}{{ campaign.name }} | Кампания | {{ block.super }}{% endblock %}

{% block content %}
<div class="card content-card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px; margin-bottom:16px;">
        <div>
            <h2>{{ campaign.name }}</h2>
            <p class="muted">Открытие: {{ campaign.opens_at|date:'d.m.Y' }}{% if campaign.deadline %}, дедлайн: {{ campaign.deadline|date:'d.m.Y' }}{% endif %}</p>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
            <span class="status status-{{ campaign.status }}">{{ campaign.get_status_display }}</span>
            {% if perms.one_time_payments.change_requestcampaign %}
                <a href="{% url 'one_time_payments:campaign-edit' campaign.pk %}" class="btn btn-text">Редактировать</a>
            {% endif %}
        </div>
    </div>
    {% if campaign.description %}
        <p style="margin-bottom:24px; white-space:pre-wrap;">{{ campaign.description }}</p>
    {% endif %}
    {% if perms.one_time_payments.change_requestcampaign %}
        {% if available_actions %}
            <section style="margin-bottom:24px;">
                <h3>Управление статусом</h3>
                <form method="post" action="{% url 'one_time_payments:campaign-status' campaign.pk %}" class="form-inline">
                    {% csrf_token %}
                    <label for="action">Действие</label>
                    <select name="action" id="action">
                        {% for value, label in available_actions %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Применить</button>
                </form>
            </section>
        {% endif %}
    {% endif %}
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
            <h3>Заявки кампании</h3>
            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                {% with params=request.GET.urlencode %}
                    <a href="{% url 'one_time_payments:campaign-requests-export' campaign.pk %}{% if params %}?{{ params }}{% endif %}" class="btn btn-text">Выгрузить в Excel</a>
                {% endwith %}
                <a href="{% url 'request-list' %}?campaign={{ campaign.pk }}" class="btn btn-text">Смотреть все заявки</a>
                {% if perms.stimuli.change_stimulusrequest %}
                    <form method="post" action="{% url 'one_time_payments:campaign-approve-pending' campaign.pk %}" style="margin:0;" onsubmit="return confirm('Вы уверены, что хотите одобрить все заявки на рассмотрении?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary" {% if not pending_requests_count %}disabled{% endif %}>
                            Одобрить все заявки на рассмотрении
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="filter-wrapper" style="margin-top:12px;">
            <style>
                .form-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 16px;
                }
                .form-grid > div > label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                }
                .multi-filter {
                    position: relative;
                    width: 100%;
                }
                .multi-filter__toggle {
                    width: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    min-height: 38px;
                    padding: 8px 12px;
                    border: 1px solid rgba(0, 0, 0, 0.1);
                    border-radius: 6px;
                    background: #fff;
                    color: inherit;
                    cursor: pointer;
                    gap: 8px;
                    box-sizing: border-box;
                    transition: border-color 0.15s ease, box-shadow 0.15s ease;
                }
                .multi-filter__toggle:hover,
                .multi-filter.open .multi-filter__toggle {
                    border-color: rgba(15, 91, 255, 0.45);
                    box-shadow: 0 0 0 3px rgba(15, 91, 255, 0.12);
                }
                .multi-filter__toggle span[data-label] {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    text-align: left;
                    flex: 1;
                }
                .multi-filter__toggle::after {
                    content: '';
                    border-left: 5px solid transparent;
                    border-right: 5px solid transparent;
                    border-top: 5px solid rgba(0, 0, 0, 0.45);
                    transition: transform 0.2s ease;
                }
                .multi-filter.open .multi-filter__toggle::after {
                    transform: rotate(180deg);
                }
                .multi-filter__menu {
                    position: absolute;
                    top: calc(100% + 4px);
                    left: 0;
                    right: 0;
                    padding: 8px;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    max-height: 270px;
                    overflow-y: auto;
                    overflow-x: hidden;
                    background: #fff;
                    border: 1px solid rgba(15, 23, 42, 0.12);
                    border-radius: 10px;
                    box-shadow: 0 16px 32px rgba(15, 23, 42, 0.18);
                    opacity: 0;
                    visibility: hidden;
                    pointer-events: none;
                    transform: translateY(-6px);
                    transition: opacity 0.16s ease, transform 0.16s ease;
                    z-index: 1000;
                    min-width: 0;
                }
                .multi-filter.open .multi-filter__menu {
                    opacity: 1;
                    visibility: visible;
                    pointer-events: auto;
                    transform: translateY(0);
                }
                .multi-filter__menu label {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                    line-height: 1.4;
                    cursor: pointer;
                    padding: 6px 8px;
                    border-radius: 6px;
                    transition: background-color 0.15s ease;
                    white-space: nowrap;
                    min-width: 0;
                }
                .multi-filter__menu label:hover {
                    background-color: rgba(15, 91, 255, 0.08);
                }
                .multi-filter__menu input[type="checkbox"] {
                    margin: 0;
                    flex-shrink: 0;
                    width: 16px;
                    height: 16px;
                }
            </style>
            <form method="get" class="filter-form" data-preserve-scroll="true">
                <div class="form-grid">
                    <div>
                        <label>Сотрудник</label>
                        <div data-multiselect="employees" class="multi-filter" data-default-label="Все сотрудники" data-counter-label="Сотрудники">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if selected_employee_ids %}
                                        Сотрудники ({{ selected_employee_ids|length }})
                                    {% else %}
                                        Все сотрудники
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="employees" value="__all__" data-select-all data-label="Все сотрудники" {% if not selected_employee_ids %}checked{% endif %}>
                                    Все сотрудники
                                </label>
                                {% for employee in employee_options %}
                                    <label>
                                        <input type="checkbox" name="employees" value="{{ employee.id }}" data-option data-label="{{ employee.full_name }}" {% if employee.id in selected_employee_ids %}checked{% endif %}>
                                        {{ employee.full_name }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Подразделение</label>
                        <div data-multiselect="divisions" class="multi-filter" data-default-label="Все подразделения" data-counter-label="Подразделения">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if selected_division_ids %}
                                        Подразделения ({{ selected_division_ids|length }})
                                    {% else %}
                                        Все подразделения
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="divisions" value="__all__" data-select-all data-label="Все подразделения" {% if not selected_division_ids %}checked{% endif %}>
                                    Все подразделения
                                </label>
                                {% for division in division_options %}
                                    <label>
                                        <input type="checkbox" name="divisions" value="{{ division.id }}" data-option data-label="{{ division.name }}" {% if division.id in selected_division_ids %}checked{% endif %}>
                                        {{ division.name }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Статус</label>
                        <div data-multiselect="statuses" class="multi-filter" data-default-label="Все статусы" data-counter-label="Статусы">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if selected_statuses %}
                                        Статусы ({{ selected_statuses|length }})
                                    {% else %}
                                        Все статусы
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="status" value="__all__" data-select-all data-label="Все статусы" {% if not selected_statuses %}checked{% endif %}>
                                    Все статусы
                                </label>
                                {% for value, label in status_options %}
                                    <label>
                                        <input type="checkbox" name="status" value="{{ value }}" data-option data-label="{{ label }}" {% if value in selected_statuses %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Ответственный</label>
                        <div data-multiselect="responsibles" class="multi-filter" data-default-label="Все ответственные" data-counter-label="Ответственные">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if selected_responsible_ids %}
                                        Ответственные ({{ selected_responsible_ids|length }})
                                    {% else %}
                                        Все ответственные
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="requested_by" value="__all__" data-select-all data-label="Все ответственные" {% if not selected_responsible_ids %}checked{% endif %}>
                                    Все ответственные
                                </label>
                                {% for option in responsible_options %}
                                    <label>
                                        <input type="checkbox" name="requested_by" value="{{ option.id }}" data-option data-label="{{ option.display }}" {% if option.id in selected_responsible_ids %}checked{% endif %}>
                                        {{ option.display }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="sort" value="{{ sorting.current_sort }}">
                <input type="hidden" name="direction" value="{{ sorting.current_direction }}">
                {% for employee_id in approved_employee_ids %}
                    <input type="hidden" name="approved_employees" value="{{ employee_id }}">
                {% endfor %}
                {% for division_id in approved_division_ids %}
                    <input type="hidden" name="approved_divisions" value="{{ division_id }}">
                {% endfor %}
                {% for responsible_id in approved_responsible_ids %}
                    <input type="hidden" name="approved_responsible" value="{{ responsible_id }}">
                {% endfor %}
                <div class="filter-actions" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
                    <button type="submit" class="btn btn-primary">Применить</button>
                    <a href="{{ requests_reset_url }}" class="btn btn-text">Сбросить</a>
                </div>
            </form>
        </div>
        <div class="table-wrapper" id="campaign-request-table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        {% with header=sorting.created %}
                            <th>
                                <a href="{{ header.url }}">
                                    Создано{% if header.is_active %} {% if header.current_direction == 'asc' %}&#9650;{% else %}&#9660;{% endif %}{% endif %}
                                </a>
                            </th>
                        {% endwith %}
                        {% with header=sorting.employee %}
                            <th>
                                <a href="{{ header.url }}">
                                    Сотрудник{% if header.is_active %} {% if header.current_direction == 'asc' %}&#9650;{% else %}&#9660;{% endif %}{% endif %}
                                </a>
                            </th>
                        {% endwith %}
                        {% with header=sorting.amount %}
                            <th>
                                <a href="{{ header.url }}">
                                    Сумма{% if header.is_active %} {% if header.current_direction == 'asc' %}&#9650;{% else %}&#9660;{% endif %}{% endif %}
                                </a>
                            </th>
                        {% endwith %}
                        <th>Обоснование</th>
                        {% with header=sorting.status %}
                            <th>
                                <a href="{{ header.url }}">
                                    Статус{% if header.is_active %} {% if header.current_direction == 'asc' %}&#9650;{% else %}&#9660;{% endif %}{% endif %}
                                </a>
                            </th>
                        {% endwith %}
                        {% with header=sorting.responsible %}
                            <th style="min-width: 150px;">
                                <a href="{{ header.url }}">
                                    Ответственный{% if header.is_active %} {% if header.current_direction == 'asc' %}&#9650;{% else %}&#9660;{% endif %}{% endif %}
                                </a>
                            </th>
                        {% endwith %}
                        <th>Комментарий</th>
                        {% if perms.stimuli.change_stimulusrequest %}
                            <th>Управление</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                        <tr id="request-{{ request.pk }}">
                            <td>{{ request.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ request.employee.full_name }}</td>
                            <td>{{ request.amount }}</td>
                            <td>{{ request.justification }}</td>
                            <td><span class="status status-{{ request.status }}">{{ request.get_display_status }}</span></td>
                            <td>{{ request.requested_by.get_full_name|default:request.requested_by.username }}</td>
                            <td>{{ request.admin_comment|default:'—' }}</td>
                            {% if perms.stimuli.change_stimulusrequest and request.status != 'archived' %}
                                <td>
                                    <form method="post" action="{% url 'one_time_payments:campaign-request-status' campaign.pk request.pk %}" data-autosubmit="true" data-autosubmit-delay="200" data-preserve-scroll="true" style="display:flex; flex-direction:column; gap:8px;">
                                        {% csrf_token %}
                                        <select name="status">
                                            {% for value, label in request.Status.choices %}
                                                <option value="{{ value }}" {% if value == request.status %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        <textarea name="admin_comment" rows="2" placeholder="Комментарий администратора" data-autosubmit-delay="1200">{{ request.admin_comment }}</textarea>
                                    </form>
                                </td>
                            {% endif %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8">Заявок в кампании нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
            <h3>Одобренные заявки (Разовые выплаты)</h3>
            {% with params=request.GET.urlencode %}
                <a href="{% url 'one_time_payments:campaign-approved-export' campaign.pk %}{% if params %}?{{ params }}{% endif %}" class="btn btn-text">Выгрузить в Excel</a>
            {% endwith %}
        </div>
        <div class="filter-wrapper" style="margin-top:12px;">
            <form method="get" class="filter-form" data-preserve-scroll="true">
                <div class="form-grid">
                    <div>
                        <label>Сотрудник</label>
                        <div class="multi-filter" data-multiselect="approved-employees" data-default-label="Все сотрудники" data-counter-label="Сотрудники">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if approved_employee_ids %}
                                        Сотрудники ({{ approved_employee_ids|length }})
                                    {% else %}
                                        Все сотрудники
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="approved_employees" value="__all__" data-select-all data-label="Все сотрудники" {% if not approved_employee_ids %}checked{% endif %}>
                                    Все сотрудники
                                </label>
                                {% for employee in approved_employee_options %}
                                    <label>
                                        <input type="checkbox" name="approved_employees" value="{{ employee.id }}" data-option data-label="{{ employee.full_name }}" {% if employee.id in approved_employee_ids %}checked{% endif %}>
                                        {{ employee.full_name }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Подразделение</label>
                        <div class="multi-filter" data-multiselect="approved-divisions" data-default-label="Все подразделения" data-counter-label="Подразделения">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if approved_division_ids %}
                                        Подразделения ({{ approved_division_ids|length }})
                                    {% else %}
                                        Все подразделения
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="approved_divisions" value="__all__" data-select-all data-label="Все подразделения" {% if not approved_division_ids %}checked{% endif %}>
                                    Все подразделения
                                </label>
                                {% for division in approved_division_options %}
                                    <label>
                                        <input type="checkbox" name="approved_divisions" value="{{ division.id }}" data-option data-label="{{ division.name }}" {% if division.id in approved_division_ids %}checked{% endif %}>
                                        {{ division.name }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Ответственный</label>
                        <div class="multi-filter" data-multiselect="approved-responsibles" data-default-label="Все ответственные" data-counter-label="Ответственные">
                            <button type="button" class="multi-filter__toggle">
                                <span data-label>
                                    {% if approved_responsible_ids %}
                                        Ответственные ({{ approved_responsible_ids|length }})
                                    {% else %}
                                        Все ответственные
                                    {% endif %}
                                </span>
                            </button>
                            <div class="multi-filter__menu">
                                <label>
                                    <input type="checkbox" name="approved_responsible" value="__all__" data-select-all data-label="Все ответственные" {% if not approved_responsible_ids %}checked{% endif %}>
                                    Все ответственные
                                </label>
                                {% for option in approved_responsible_options %}
                                    <label>
                                        <input type="checkbox" name="approved_responsible" value="{{ option.id }}" data-option data-label="{{ option.display }}" {% if option.id in approved_responsible_ids %}checked{% endif %}>
                                        {{ option.display }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="sort" value="{{ sorting.current_sort }}">
                <input type="hidden" name="direction" value="{{ sorting.current_direction }}">
                {% for employee_id in selected_employee_ids %}
                    <input type="hidden" name="employees" value="{{ employee_id }}">
                {% endfor %}
                {% for division_id in selected_division_ids %}
                    <input type="hidden" name="divisions" value="{{ division_id }}">
                {% endfor %}
                {% for status_value in selected_statuses %}
                    <input type="hidden" name="status" value="{{ status_value }}">
                {% endfor %}
                {% for responsible_id in selected_responsible_ids %}
                    <input type="hidden" name="requested_by" value="{{ responsible_id }}">
                {% endfor %}
                <div class="filter-actions" style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
                    <button type="submit" class="btn btn-primary">Применить</button>
                    <a href="{{ approved_reset_url }}" class="btn btn-text">Сбросить</a>
                </div>
            </form>
        </div>
        <div class="table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Создано</th>
                        <th>Сотрудник</th>
                        <th>Сумма</th>
                        <th>Обоснование</th>
                        <th>Ответственный</th>
                        <th>Комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in approved_requests %}
                        <tr>
                            <td>{{ item.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ item.employee.full_name }}</td>
                            <td><strong>{{ item.total_amount }}</strong></td>
                            <td>{{ item.justification|default:'—' }}</td>
                            <td>{{ item.requesters }}</td>
                            <td>{{ item.admin_comment|default:'—' }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6">Одобренных заявок нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const storageKey = 'campaign-detail-scroll';

    const getScrollY = () => {
        if (typeof window.scrollY === 'number') {
            return window.scrollY;
        }
        if (typeof window.pageYOffset === 'number') {
            return window.pageYOffset;
        }
        const doc = document.documentElement || document.body || {};
        return doc.scrollTop || 0;
    };

    const getScrollX = () => {
        if (typeof window.scrollX === 'number') {
            return window.scrollX;
        }
        if (typeof window.pageXOffset === 'number') {
            return window.pageXOffset;
        }
        const doc = document.documentElement || document.body || {};
        return doc.scrollLeft || 0;
    };

    const clampScrollValue = (value, max) => {
        if (typeof value !== 'number' || Number.isNaN(value) || !Number.isFinite(value)) {
            return 0;
        }
        let result = Math.max(0, value);
        if (typeof max === 'number' && Number.isFinite(max) && max >= 0) {
            result = Math.min(result, max);
        }
        return result;
    };

    const getMaxScrollY = () => {
        const doc = document.documentElement || {};
        const body = document.body || {};
        const scrollHeight = Math.max(doc.scrollHeight || 0, body.scrollHeight || 0);
        const viewportHeight = window.innerHeight || doc.clientHeight || body.clientHeight || 0;
        return Math.max(scrollHeight - viewportHeight, 0);
    };

    const clampScrollY = (value, max) => clampScrollValue(value, typeof max === 'number' ? max : getMaxScrollY());

    const resolveAnchorScrollY = (element, fallback, max) => {
        if (!element || typeof element.getBoundingClientRect !== 'function') {
            return clampScrollY(fallback, max);
        }

        const rect = element.getBoundingClientRect();
        const currentScrollY = getScrollY();
        const elementTop = rect.top + currentScrollY;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || rect.height;
        const targetCenter = elementTop - (viewportHeight / 2) + (rect.height / 2);
        if (!Number.isFinite(targetCenter)) {
            return clampScrollY(fallback, max);
        }
        return clampScrollY(targetCenter, max);
    };

    const restoreState = (data) => {
        let anchorElement = null;
        if (data.anchor) {
            anchorElement = document.getElementById(data.anchor);
        }

        let lastScrollPosition = null;

        const applyScroll = () => {
            const maxY = getMaxScrollY();
            let targetY;
            if (typeof data.scrollY === 'number' && Number.isFinite(data.scrollY)) {
                targetY = clampScrollY(data.scrollY, maxY);
            } else if (anchorElement) {
                targetY = resolveAnchorScrollY(anchorElement, data.scrollY, maxY);
            } else {
                targetY = clampScrollY(data.scrollY, maxY);
            }
            const doc = document.documentElement || {};
            const body = document.body || {};
            const scrollWidth = Math.max(doc.scrollWidth || 0, body.scrollWidth || 0);
            const viewportWidth = window.innerWidth || doc.clientWidth || body.clientWidth || 0;
            const maxX = Math.max(scrollWidth - viewportWidth, 0);
            const targetX = (typeof data.scrollX === 'number' && Number.isFinite(data.scrollX))
                ? clampScrollValue(data.scrollX, maxX)
                : clampScrollValue(getScrollX(), maxX);

            lastScrollPosition = { top: targetY, left: targetX };

            window.scrollTo({
                top: targetY,
                left: targetX,
                behavior: 'auto'
            });
        };

        const reapplyLastScroll = () => {
            if (!lastScrollPosition) {
                return;
            }
            window.scrollTo({
                top: lastScrollPosition.top,
                left: lastScrollPosition.left,
                behavior: 'auto'
            });
        };

        const applyWrapperScroll = () => {
            if (!data.wrapperId) {
                return;
            }
            const wrapper = document.getElementById(data.wrapperId);
            if (!wrapper) {
                return;
            }

            if (typeof data.wrapperScrollLeft === 'number') {
                const maxLeft = Math.max(wrapper.scrollWidth - wrapper.clientWidth, 0);
                wrapper.scrollLeft = clampScrollValue(data.wrapperScrollLeft, maxLeft);
            }

            if (typeof data.wrapperScrollTop === 'number') {
                const maxTop = Math.max(wrapper.scrollHeight - wrapper.clientHeight, 0);
                wrapper.scrollTop = clampScrollValue(data.wrapperScrollTop, maxTop);
            }
        };

        const applyFocus = () => {
            if (!data.fieldName) {
                return;
            }
            let field = null;
            if (anchorElement) {
                field = anchorElement.querySelector('[name="' + data.fieldName + '"]');
            }
            if (!field) {
                field = document.querySelector('[name="' + data.fieldName + '"]');
            }
            if (!field) {
                return;
            }
            try {
                field.focus({ preventScroll: true });
            } catch (error) {
                if (typeof field.focus === 'function') {
                    field.focus();
                    requestAnimationFrame(reapplyLastScroll);
                }
            }
            requestAnimationFrame(reapplyLastScroll);
            if (typeof data.selectionStart === 'number' && typeof data.selectionEnd === 'number' && typeof field.setSelectionRange === 'function') {
                field.setSelectionRange(data.selectionStart, data.selectionEnd);
            } else if (field.value && typeof field.value.length === 'number' && typeof field.setSelectionRange === 'function') {
                const length = field.value.length;
                field.setSelectionRange(length, length);
            }
            requestAnimationFrame(reapplyLastScroll);
        };

        requestAnimationFrame(() => {
            applyWrapperScroll();
            applyScroll();
            requestAnimationFrame(applyFocus);
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        let saved = null;
        try {
            saved = sessionStorage.getItem(storageKey);
        } catch (error) {
            saved = null;
        }
        if (saved) {
            try {
                sessionStorage.removeItem(storageKey);
            } catch (error) {
                // Игнорируем ошибки удаления
            }
            try {
                const parsed = JSON.parse(saved);
                if (parsed && typeof parsed === 'object') {
                    restoreState(parsed);
                }
            } catch (error) {
                // Игнорируем ошибки парсинга и не восстанавливаем состояние
            }
        }

        document.querySelectorAll('form[data-preserve-scroll="true"]').forEach((form) => {
            form.addEventListener('submit', () => {
                const activeElement = document.activeElement;
                const payload = {
                    scrollY: getScrollY(),
                    scrollX: getScrollX()
                };

                const anchor = form.closest('tr[id]');
                if (anchor && anchor.id) {
                    payload.anchor = anchor.id;
                }

                let wrapper = document.getElementById('campaign-request-table-wrapper');
                if (!wrapper) {
                    wrapper = form.closest('.table-wrapper');
                }
                if (wrapper) {
                    if (!wrapper.id) {
                        wrapper.id = 'campaign-request-table-wrapper';
                    }
                    payload.wrapperId = wrapper.id;
                    payload.wrapperScrollLeft = wrapper.scrollLeft;
                    payload.wrapperScrollTop = wrapper.scrollTop;
                }

                if (activeElement && form.contains(activeElement) && activeElement.name) {
                    payload.fieldName = activeElement.name;
                    if (typeof activeElement.selectionStart === 'number' && typeof activeElement.selectionEnd === 'number') {
                        payload.selectionStart = activeElement.selectionStart;
                        payload.selectionEnd = activeElement.selectionEnd;
                    }
                }

                try {
                    sessionStorage.setItem(storageKey, JSON.stringify(payload));
                } catch (error) {
                    // Если sessionStorage недоступен, просто пропускаем сохранение
                }
            });
        });

        function closeAllMultiselects(target, exception) {
            document.querySelectorAll('[data-multiselect].open').forEach((container) => {
                if (container === exception) {
                    return;
                }
                if (!target || !container.contains(target)) {
                    container.classList.remove('open');
                }
            });
        }

        const initMultiselect = (container) => {
            const toggle = container.querySelector('.multi-filter__toggle');
            const menu = container.querySelector('.multi-filter__menu');
            if (!toggle || !menu) {
                return;
            }

            const labelNode = toggle.querySelector('[data-label]');
            const defaultLabel = container.dataset.defaultLabel || (labelNode ? labelNode.textContent.trim() : '');
            const counterLabel = container.dataset.counterLabel || defaultLabel || 'Выбрано';
            const selectAll = container.querySelector('input[data-select-all]');
            const optionCheckboxes = Array.from(container.querySelectorAll('input[data-option]'));

            const updateLabel = () => {
                if (!labelNode) {
                    return;
                }

                if (selectAll && selectAll.checked) {
                    labelNode.textContent = defaultLabel || 'Все';
                    return;
                }

                const selectedLabels = optionCheckboxes
                    .filter((checkbox) => checkbox.checked)
                    .map((checkbox) => checkbox.dataset.label || checkbox.value);

                if (selectedLabels.length === 0) {
                    labelNode.textContent = defaultLabel || 'Все';
                    if (selectAll) {
                        selectAll.checked = true;
                    }
                    return;
                }

                if (selectedLabels.length === 1) {
                    labelNode.textContent = selectedLabels[0];
                } else {
                    labelNode.textContent = `${counterLabel} (${selectedLabels.length})`;
                }
            };

            const refreshSelectAll = () => {
                if (!selectAll) {
                    return;
                }
                const hasSelection = optionCheckboxes.some((checkbox) => checkbox.checked);
                selectAll.checked = !hasSelection;
            };

            const setOpen = (value) => {
                if (value) {
                    closeAllMultiselects(null, container);
                    container.classList.add('open');
                } else {
                    container.classList.remove('open');
                }
            };

            toggle.addEventListener('click', (event) => {
                event.preventDefault();
                const willOpen = !container.classList.contains('open');
                setOpen(willOpen);
            });

            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    if (selectAll.checked) {
                        optionCheckboxes.forEach((checkbox) => {
                            checkbox.checked = false;
                        });
                    }
                    updateLabel();
                    refreshSelectAll();
                });
            }

            optionCheckboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked && selectAll) {
                        selectAll.checked = false;
                    } else if (!optionCheckboxes.some((option) => option.checked) && selectAll) {
                        selectAll.checked = true;
                    }
                    updateLabel();
                });
            });

            refreshSelectAll();
            updateLabel();
        };

        document.querySelectorAll('[data-multiselect]').forEach((container) => {
            initMultiselect(container);
        });

        document.addEventListener('click', (event) => {
            closeAllMultiselects(event.target);
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeAllMultiselects();
            }
        });

        // Сохранение позиции скролла при клике на кнопки сброса
        document.querySelectorAll('.filter-actions a').forEach((resetLink) => {
            if (resetLink.textContent.includes('Сбросить')) {
                resetLink.addEventListener('click', () => {
                    const payload = {
                        scrollY: getScrollY(),
                        scrollX: getScrollX()
                    };
                    
                    let wrapper = document.getElementById('campaign-request-table-wrapper');
                    if (wrapper) {
                        payload.wrapperId = wrapper.id;
                        payload.wrapperScrollLeft = wrapper.scrollLeft;
                        payload.wrapperScrollTop = wrapper.scrollTop;
                    }
                    
                    try {
                        sessionStorage.setItem(storageKey, JSON.stringify(payload));
                    } catch (error) {
                        // Игнорируем ошибки
                    }
                });
            }
        });

    });
})();
</script>
{% endblock %}
