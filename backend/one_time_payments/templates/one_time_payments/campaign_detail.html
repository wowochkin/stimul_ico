{% extends 'base.html' %}

{% block title %}{{ campaign.name }} | Кампания | {{ block.super }}{% endblock %}

{% block content %}
<div class="card content-card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px; margin-bottom:16px;">
        <div>
            <h2>{{ campaign.name }}</h2>
            <p class="muted">Открытие: {{ campaign.opens_at|date:'d.m.Y' }}{% if campaign.deadline %}, дедлайн: {{ campaign.deadline|date:'d.m.Y' }}{% endif %}</p>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
            <span class="status status-{{ campaign.status }}">{{ campaign.get_status_display }}</span>
            {% if perms.one_time_payments.change_requestcampaign %}
                <a href="{% url 'one_time_payments:campaign-edit' campaign.pk %}" class="btn btn-text">Редактировать</a>
            {% endif %}
        </div>
    </div>
    {% if campaign.description %}
        <p style="margin-bottom:24px; white-space:pre-wrap;">{{ campaign.description }}</p>
    {% endif %}
    {% if perms.one_time_payments.change_requestcampaign %}
        {% if available_actions %}
            <section style="margin-bottom:24px;">
                <h3>Управление статусом</h3>
                <form method="post" action="{% url 'one_time_payments:campaign-status' campaign.pk %}" class="form-inline">
                    {% csrf_token %}
                    <label for="action">Действие</label>
                    <select name="action" id="action">
                        {% for value, label in available_actions %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Применить</button>
                </form>
            </section>
        {% endif %}
    {% endif %}
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
            <h3>Заявки кампании</h3>
            <a href="{% url 'request-list' %}?campaign={{ campaign.pk }}" class="btn btn-text">Смотреть все заявки</a>
        </div>
        <div class="table-wrapper" id="campaign-request-table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Создано</th>
                        <th>Сотрудник</th>
                        <th>Сумма</th>
                        <th>Обоснование</th>
                        <th>Статус</th>
                        <th>Ответственный</th>
                        <th>Комментарий</th>
                        {% if perms.stimuli.change_stimulusrequest %}
                            <th>Управление</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for request in campaign.stimulus_requests.all %}
                        <tr id="request-{{ request.pk }}">
                            <td>{{ request.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ request.employee.full_name }}</td>
                            <td>{{ request.amount }}</td>
                            <td>{{ request.justification }}</td>
                            <td><span class="status status-{{ request.status }}">{{ request.get_display_status }}</span></td>
                            <td>{{ request.requested_by.get_full_name|default:request.requested_by.username }}</td>
                            <td>{{ request.admin_comment|default:'—' }}</td>
                            {% if perms.stimuli.change_stimulusrequest and request.status != 'archived' %}
                                <td>
                                    <form method="post" action="{% url 'one_time_payments:campaign-request-status' campaign.pk request.pk %}" data-autosubmit="true" data-autosubmit-delay="200" data-preserve-scroll="true" style="display:flex; flex-direction:column; gap:8px;">
                                        {% csrf_token %}
                                        <select name="status">
                                            {% for value, label in request.Status.choices %}
                                                <option value="{{ value }}" {% if value == request.status %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        <textarea name="admin_comment" rows="2" placeholder="Комментарий администратора" data-autosubmit-delay="1200">{{ request.admin_comment }}</textarea>
                                    </form>
                                </td>
                            {% endif %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8">Заявок в кампании нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <section style="margin-bottom:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
            <h3>Одобренные заявки (Разовые выплаты)</h3>
            <a href="{% url 'one_time_payments:campaign-approved-export' campaign.pk %}" class="btn btn-text">Выгрузить в Excel</a>
        </div>
        <div class="table-wrapper" style="margin-top:12px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Создано</th>
                        <th>Сотрудник</th>
                        <th>Сумма</th>
                        <th>Обоснование</th>
                        <th>Ответственный</th>
                        <th>Комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in approved_requests_grouped %}
                        <tr>
                            <td>{{ item.created_at|date:'d.m.Y H:i' }}</td>
                            <td>{{ item.employee.full_name }}</td>
                            <td><strong>{{ item.total_amount }}</strong></td>
                            <td>{{ item.justification|default:'—' }}</td>
                            <td>{{ item.requesters }}</td>
                            <td>{{ item.admin_comment|default:'—' }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6">Одобренных заявок нет.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const storageKey = 'campaign-detail-scroll';

    const getScrollY = () => {
        if (typeof window.scrollY === 'number') {
            return window.scrollY;
        }
        if (typeof window.pageYOffset === 'number') {
            return window.pageYOffset;
        }
        const doc = document.documentElement || document.body || {};
        return doc.scrollTop || 0;
    };

    const getScrollX = () => {
        if (typeof window.scrollX === 'number') {
            return window.scrollX;
        }
        if (typeof window.pageXOffset === 'number') {
            return window.pageXOffset;
        }
        const doc = document.documentElement || document.body || {};
        return doc.scrollLeft || 0;
    };

    const clampScrollValue = (value, max) => {
        if (typeof value !== 'number' || Number.isNaN(value) || !Number.isFinite(value)) {
            return 0;
        }
        let result = Math.max(0, value);
        if (typeof max === 'number' && Number.isFinite(max) && max >= 0) {
            result = Math.min(result, max);
        }
        return result;
    };

    const getMaxScrollY = () => {
        const doc = document.documentElement || {};
        const body = document.body || {};
        const scrollHeight = Math.max(doc.scrollHeight || 0, body.scrollHeight || 0);
        const viewportHeight = window.innerHeight || doc.clientHeight || body.clientHeight || 0;
        return Math.max(scrollHeight - viewportHeight, 0);
    };

    const clampScrollY = (value, max) => clampScrollValue(value, typeof max === 'number' ? max : getMaxScrollY());

    const resolveAnchorScrollY = (element, fallback, max) => {
        if (!element || typeof element.getBoundingClientRect !== 'function') {
            return clampScrollY(fallback, max);
        }

        const rect = element.getBoundingClientRect();
        const currentScrollY = getScrollY();
        const elementTop = rect.top + currentScrollY;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || rect.height;
        const targetCenter = elementTop - (viewportHeight / 2) + (rect.height / 2);
        if (!Number.isFinite(targetCenter)) {
            return clampScrollY(fallback, max);
        }
        return clampScrollY(targetCenter, max);
    };

    const restoreState = (data) => {
        let anchorElement = null;
        if (data.anchor) {
            anchorElement = document.getElementById(data.anchor);
        }

        let lastScrollPosition = null;

        const applyScroll = () => {
            const maxY = getMaxScrollY();
            let targetY;
            if (typeof data.scrollY === 'number' && Number.isFinite(data.scrollY)) {
                targetY = clampScrollY(data.scrollY, maxY);
            } else if (anchorElement) {
                targetY = resolveAnchorScrollY(anchorElement, data.scrollY, maxY);
            } else {
                targetY = clampScrollY(data.scrollY, maxY);
            }
            const doc = document.documentElement || {};
            const body = document.body || {};
            const scrollWidth = Math.max(doc.scrollWidth || 0, body.scrollWidth || 0);
            const viewportWidth = window.innerWidth || doc.clientWidth || body.clientWidth || 0;
            const maxX = Math.max(scrollWidth - viewportWidth, 0);
            const targetX = (typeof data.scrollX === 'number' && Number.isFinite(data.scrollX))
                ? clampScrollValue(data.scrollX, maxX)
                : clampScrollValue(getScrollX(), maxX);

            lastScrollPosition = { top: targetY, left: targetX };

            window.scrollTo({
                top: targetY,
                left: targetX,
                behavior: 'auto'
            });
        };

        const reapplyLastScroll = () => {
            if (!lastScrollPosition) {
                return;
            }
            window.scrollTo({
                top: lastScrollPosition.top,
                left: lastScrollPosition.left,
                behavior: 'auto'
            });
        };

        const applyWrapperScroll = () => {
            if (!data.wrapperId) {
                return;
            }
            const wrapper = document.getElementById(data.wrapperId);
            if (!wrapper) {
                return;
            }

            if (typeof data.wrapperScrollLeft === 'number') {
                const maxLeft = Math.max(wrapper.scrollWidth - wrapper.clientWidth, 0);
                wrapper.scrollLeft = clampScrollValue(data.wrapperScrollLeft, maxLeft);
            }

            if (typeof data.wrapperScrollTop === 'number') {
                const maxTop = Math.max(wrapper.scrollHeight - wrapper.clientHeight, 0);
                wrapper.scrollTop = clampScrollValue(data.wrapperScrollTop, maxTop);
            }
        };

        const applyFocus = () => {
            if (!data.fieldName) {
                return;
            }
            let field = null;
            if (anchorElement) {
                field = anchorElement.querySelector('[name="' + data.fieldName + '"]');
            }
            if (!field) {
                field = document.querySelector('[name="' + data.fieldName + '"]');
            }
            if (!field) {
                return;
            }
            try {
                field.focus({ preventScroll: true });
            } catch (error) {
                if (typeof field.focus === 'function') {
                    field.focus();
                    requestAnimationFrame(reapplyLastScroll);
                }
            }
            requestAnimationFrame(reapplyLastScroll);
            if (typeof data.selectionStart === 'number' && typeof data.selectionEnd === 'number' && typeof field.setSelectionRange === 'function') {
                field.setSelectionRange(data.selectionStart, data.selectionEnd);
            } else if (field.value && typeof field.value.length === 'number' && typeof field.setSelectionRange === 'function') {
                const length = field.value.length;
                field.setSelectionRange(length, length);
            }
            requestAnimationFrame(reapplyLastScroll);
        };

        requestAnimationFrame(() => {
            applyWrapperScroll();
            applyScroll();
            requestAnimationFrame(applyFocus);
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        let saved = null;
        try {
            saved = sessionStorage.getItem(storageKey);
        } catch (error) {
            saved = null;
        }
        if (saved) {
            try {
                sessionStorage.removeItem(storageKey);
            } catch (error) {
                // Игнорируем ошибки удаления
            }
            try {
                const parsed = JSON.parse(saved);
                if (parsed && typeof parsed === 'object') {
                    restoreState(parsed);
                }
            } catch (error) {
                // Игнорируем ошибки парсинга и не восстанавливаем состояние
            }
        }

        document.querySelectorAll('form[data-preserve-scroll="true"]').forEach((form) => {
            form.addEventListener('submit', () => {
                const activeElement = document.activeElement;
                const payload = {
                    scrollY: getScrollY(),
                    scrollX: getScrollX()
                };

                const anchor = form.closest('tr[id]');
                if (anchor && anchor.id) {
                    payload.anchor = anchor.id;
                }

                let wrapper = document.getElementById('campaign-request-table-wrapper');
                if (!wrapper) {
                    wrapper = form.closest('.table-wrapper');
                }
                if (wrapper) {
                    if (!wrapper.id) {
                        wrapper.id = 'campaign-request-table-wrapper';
                    }
                    payload.wrapperId = wrapper.id;
                    payload.wrapperScrollLeft = wrapper.scrollLeft;
                    payload.wrapperScrollTop = wrapper.scrollTop;
                }

                if (activeElement && form.contains(activeElement) && activeElement.name) {
                    payload.fieldName = activeElement.name;
                    if (typeof activeElement.selectionStart === 'number' && typeof activeElement.selectionEnd === 'number') {
                        payload.selectionStart = activeElement.selectionStart;
                        payload.selectionEnd = activeElement.selectionEnd;
                    }
                }

                try {
                    sessionStorage.setItem(storageKey, JSON.stringify(payload));
                } catch (error) {
                    // Если sessionStorage недоступен, просто пропускаем сохранение
                }
            });
        });
    });
})();
</script>
{% endblock %}
