{% extends 'base.html' %}

{% block title %}Постоянные выплаты | {{ block.super }}{% endblock %}

{% block content %}
<div class="card content-card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:16px;">
        <h2>Периоды постоянных выплат</h2>
        {% if perms.recurring_payments.add_recurringperiod %}
            <a href="{% url 'recurring_payments:period-add' %}" class="btn btn-primary">Новый период</a>
        {% endif %}
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Период</th>
                    <th>Статус</th>
                    <th>Лимит бюджета</th>
                    <th>Выплаты</th>
                    <th>Остаток</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for period in periods %}
                    <tr>
                        <td><a href="{% url 'recurring_payments:period-detail' period.pk %}">{{ period.name }}</a></td>
                        <td>{{ period.start_date|date:'d.m.Y' }} — {{ period.end_date|date:'d.m.Y' }}</td>
                        <td><span class="status status-{{ period.status }}">{{ period.get_status_display }}</span></td>
                        <td>{{ period.budget_limit|default:0 }}</td>
                        <td>{{ period.total_payments }}</td>
                        <td>{{ period.remaining_budget }}</td>
                        <td style="display:flex; gap:8px; flex-wrap:wrap;">
                            <a href="{% url 'recurring_payments:period-detail' period.pk %}" class="btn btn-text">Подробнее</a>
                            {% if perms.recurring_payments.change_recurringperiod %}
                                <a href="{% url 'recurring_payments:period-edit' period.pk %}" class="btn btn-text">Редактировать</a>
                                {% if period.status == period.Status.DRAFT %}
                                    <form method="post" action="{% url 'recurring_payments:period-open' period.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-text">Открыть</button>
                                    </form>
                                {% elif period.status == period.Status.OPEN %}
                                    <form method="post" action="{% url 'recurring_payments:period-close' period.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="reason" value="Авто-закрытие из списка">
                                        <button type="submit" class="btn btn-text" onclick="return confirm('Закрыть период?')">Закрыть</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7">Периоды отсутствуют.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">Назад</a>
            {% endif %}
            <span class="current">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Вперёд</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
