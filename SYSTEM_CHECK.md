# Проверка работы системы прав доступа

## Команды для проверки

### 1. Проверка связей пользователей и сотрудников
```bash
python3 manage.py check_connections
```

### 2. Проверка фильтрации подразделений
```bash
python3 manage.py test_division_filtering
```

### 3. Проверка доступных сотрудников для каждого пользователя
```bash
python3 manage.py shell -c "
from django.contrib.auth.models import User
from stimuli.permissions import get_accessible_employees

for username in ['manager_dev', 'employee_dev', 'manager_marketing', 'employee_marketing']:
    try:
        user = User.objects.get(username=username)
        employees = get_accessible_employees(user)
        print(f'{username}: {employees.count()} сотрудников')
        for emp in employees:
            print(f'  - {emp.full_name} ({emp.division.name})')
    except User.DoesNotExist:
        print(f'{username}: НЕ НАЙДЕН')
    print()
"
```

### 3. Проверка ограничений для сотрудников
```bash
python3 manage.py test_employee_restrictions
```

## Ожидаемые результаты

### manager_dev (руководитель отдела разработки)
- Доступные подразделения: только "Отдел разработки"
- Доступные сотрудники: сотрудники отдела разработки
- Доступные кампании: все кроме черновиков
- Может создавать заявки для сотрудников своего подразделения
- Может изменять статус заявок своего подразделения

### employee_dev (сотрудник отдела разработки)
- Доступные подразделения: пустой список
- Доступные сотрудники: только себя
- Доступные кампании: только открытые
- Может создавать заявки только для себя
- НЕ может изменять статус заявок

### manager_marketing (руководитель отдела маркетинга)
- Доступные подразделения: только "Отдел маркетинга"
- Доступные сотрудники: сотрудники отдела маркетинга
- Доступные кампании: только открытые
- Может создавать заявки для сотрудников своего подразделения
- НЕ может изменять статус заявок
- Может удалять только свои заявки в статусе "На рассмотрении"

### employee_marketing (сотрудник отдела маркетинга)
- Доступные подразделения: пустой список
- Доступные сотрудники: только себя
- Доступные кампании: только открытые
- Может создавать заявки только для себя
- НЕ может изменять статус заявок

## Проверка в админке

1. Зайдите в админку Django
2. Перейдите в раздел "Сотрудники"
3. Убедитесь, что у каждого сотрудника указан пользователь в поле "Пользователь"
4. Перейдите в раздел "Подразделения пользователей"
5. Убедитесь, что у руководителей департамента указаны их подразделения

## Тестирование форм

1. Войдите как руководитель департамента
2. Перейдите к созданию заявки
3. В выпадающем списке сотрудников должны быть только сотрудники вашего подразделения
4. Перейдите к массовому созданию заявок
5. В выпадающем списке подразделений должно быть только ваше подразделение

Если результаты не соответствуют ожидаемым, выполните команды исправления из `TROUBLESHOOTING.md`.
